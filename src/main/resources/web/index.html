<html>
<link rel="stylesheet" href="jquery-ui.structure.min.css">
<link rel="stylesheet" href="jquery-ui.min.css">

<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="jquery-ui.min.js"></script>
<script type="text/javascript">

var NEXT_CHEST_TIME = 1000 * 3600 * 6;
var THEE_DAYS_MILLIS = 1000 * 3600 * 24 * 3;

var signal = function(){
    var audio = document.getElementById('audio');
    if(audio.paused){
        audio.currentTime = 0;
        audio.play();
    }
}

var createTable = function(data){
    var oldTable = document.getElementById("users");
    var newTable = document.createElement('table');
    newTable.id = "users";
    newTable.border = "1px solid #000000";

    var colNames = ["Photo", "Friend", "Next chest time", "Opened by"];
    var names = document.createElement('tr');
    for(var i in colNames) {
        var td = document.createElement('td');
        td.style.textAlign = "center";
        td.appendChild(document.createTextNode(colNames[i]));
        names.appendChild(td);
    }
    newTable.appendChild(names);

    data.sort(function(a,b){if(a.time ==0){ return 1} else if(b.time==0) {return -1} else {return parseInt(a.time) - parseInt(b.time)}})
    for (var i = 0; i < data.length; i++){
        var tr = document.createElement('tr');
        var td1 = document.createElement('td');
        var td2 = document.createElement('td');
        var td3 = document.createElement('td');
        var td4 = document.createElement('td');
        var name = document.createTextNode(data[i].name);
        var time = data[i].time;
        var now = new Date().getTime();
        if(now - (data[i].logintime * 1000) > THEE_DAYS_MILLIS) {
                time = "not playing";
        } else if(time == 0) {
                time = "closed";
                td3.style.backgroundColor = "greenyellow";
        } else {
            time = new Date(data[i].time * 1000 + NEXT_CHEST_TIME);
            if((time - now < 30000) && (time - now > 0)){
                signal();
                td3.style.backgroundColor = "greenyellow";
            }
            if(data[i].openedBy) {
                var openedBy = data[i].openedBy;
                var openedPhoto = document.createElement("img");
                openedPhoto.src = openedBy.photo;
                openedPhoto.width = 38;
                openedPhoto.height = 38;
                openedPhoto.style.verticalAlign = "middle";
                td4.appendChild(openedPhoto);
                td4.appendChild(document.createTextNode(openedBy.name));
            }
        }
        var time  = document.createTextNode(time);
        var photo = document.createElement("img");
        photo.src = data[i].photo;
        photo.width = 38;
        photo.height = 38;

        td1.appendChild(photo);
        td2.appendChild(name);
        td3.appendChild(time);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        newTable.appendChild(tr);
    }
    if(oldTable != null){
        document.body.replaceChild(newTable, oldTable);
    } else{
        document.body.appendChild(newTable);
    }
}
var login = function(){
    var jsonCredentials = document.getElementById("cred").value;
    $.post('http://localhost:8080/elka/credentials', "forsefetch=true&cred="+jsonCredentials, function(d){
        if(d.status == "saved"){
            removeLoginDiv();
        }
    }).fail(function(a){
        alert(a.responseJSON.error);
    });
}
var removeLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        document.body.removeChild(loginDiv);
    }
}
var createLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        return;
    }
    var div = document.createElement('div');
    div.id = "login";
    div.style.width = 450;
    div.style.height = 250;
    var textarea = document.createElement('textarea');
    textarea.id = "cred";
    textarea.name = "credentials";
    textarea.cols = 50;
    textarea.rows = 15;
    var button = document.createElement('button');
    button.onclick = login;
    button.innerHTML = "Login";

    div.appendChild(textarea);
    div.appendChild(button);
    document.body.appendChild(div);
}

var initExpiditions = function(expiditions) {
    var active_expeditions = expiditions.active;
    $("#active_expeditions li").remove();
    for(i in active_expeditions){
        var item = $("#available_expeditions").find("[exp_id=" + active_expeditions[i] + "]");
        if(item.length == 0) {
            continue;
        }
        item.clone().appendTo($("#active_expeditions"));
    }
    var saved_expeditions = expiditions.saved;
    //try to fetch if not set at all.
    if($("#saved_expeditions li").length == 0) {
        for(i in saved_expeditions) {
            var item = $("#available_expeditions").find("[exp_id=" + saved_expeditions[i] + "]");
            if(item.length == 0) {
                continue;
            }
            item.clone().appendTo($("#saved_expeditions"));
        }
    }
}
var failedRequests = 0;
var start = function(){
    $.post('http://localhost:8080/elka/userchests', "", function(d){
        if(!d.credentials.valid){
            var table = document.getElementById("users");
            if(table != null){
                document.body.removeChild(table);
            }
            createLoginDiv();
            return;
        }
        removeLoginDiv();
        createTable(d.chests);
        initExpiditions(d.expiditions);
    }).fail(function(a,b,c){
      failedRequests++;
      if(failedRequests >= 5){
        clearInterval(interval);
        var item = document.getElementById("users");
        if(item == null){
            item = document.getElementById('login');
        }
        item = $('#'+item.id);
        $("#overlay").css({
            position: "absolute",
            width: item.width(),
            height: item.height(),
            left: item.position().left,
            top: item.position().top,
            zIndex: 100,
            "background-color": "#000000",
            opacity: 0.7
        });
      }
    });
}
var interval = setInterval(start, 1000);
start();

$(document).ready(function(){
    $('#available_expeditions').accordion();
    $('#available_expeditions li').draggable({cursor:'move', helper: 'clone', activeClass: "ui-state-default", hoverClass: "ui-state-hover"});
    $('#saved_expeditions').droppable({
        drop: function( event, ui ) {
            var count = 0;
            $("#saved_expeditions li").each(function(i, item){ 
                count += parseInt($(item).attr("deer"));
            });
            if(count + parseInt(ui.draggable.attr("deer")) > 6) {
                return;
            }
            ui.draggable.clone().draggable().appendTo(this);
            var id = ui.draggable.attr("exp_id");
            $.post('http://localhost:8080/elka/expiditions/add', "id=" + id, function(d){
                if(!d.saved) {
                    alert(d.msg);
                }
            }).fail(function(a){
                alert(a.responseText || a.statusText);
            });
        },
        out: function(event, ui) {
            if(ui.draggable.parents("#saved_expeditions").length == 0) {
                return;
            }
            ui.helper.remove();
            var id = ui.draggable.attr("exp_id");
            $.post('http://localhost:8080/elka/expiditions/del', "id=" + id, function(d){
                console.log(d);
            }).fail(function(a){
                alert(a.responseText || a.statusText);
            });
        }
    });
});
</script>
<body>
<audio id="audio">
  <source src="beep.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
<div id="overlay"></div>
<div id="expeditions_info" style="width: 600px;float: right; margin-right: 400px;">
    <fieldset>
        <legend>Экспедиции</legend>
        <fieldset>
            <legend>Доступные экспедиции</legend>
            <div id="available_expeditions">
                <h4><a href="#">Зима</a></h4>
                <div>
                    <ul>
                        <li exp_id="1" deer="1">Гренландия(3-5, 1ч., 1 олень)</li>
                        <li exp_id="2" deer="2">Лапландия(5-16, 2ч., 2 оленя)</li>
                        <li exp_id="3" deer="3">Аляска(15-40, 4ч., 3 оленя)</li>
                        <li exp_id="4" deer="4">Южный полюс(30-100, 8ч., 4 оленя)</li>
                        <li exp_id="5" deer="5">Северный полюс(50-250, 16ч., 5 оленей)</li>
                        <li exp_id="6" deer="6">Великий Устюг(100-300, 24ч., 6 оленей)</li>
                    </ul>
                </div>
                <h4><a href="#">Весна</a></h4>
                <div>
                    <ul>
                        <li exp_id="7" deer="1">Страна Тюльпанов(4-6, 1ч., 1 олень)</li>
                        <li exp_id="8" deer="2">Луга Ромашек(6-17, 2ч., 2 оленя)</li>
                        <li exp_id="9" deer="3">Сады Сирени(17-45, 4ч., 3 оленя)</li>
                        <li exp_id="10" deer="4">Озеро Лиллий(35-110, 8ч., 4 оленя)</li>
                        <li exp_id="11" deer="5">Парк Роз(50-275, 16ч., 5 оленей)</li>
                        <li exp_id="12" deer="6">Поля Клевера(110-330, 24ч., 6 оленей)</li>
                    </ul>
                </div>
                <h4><a href="#">Лето</a></h4>
                <div>
                    <ul>
                        <li exp_id="13" deer="1">Поля Пшеницы(4-6, 1ч., 1 олень)</li>
                        <li exp_id="14" deer="2">Поля Кукурузы(6-18, 2ч., 2 оленя)</li>
                        <li exp_id="15" deer="3">Поля Подсолнухов(18-48, 4ч., 3 оленя)</li>
                        <li exp_id="16" deer="4">Сливовый Сад(36-120, 8ч., 4 оленя)</li>
                        <li exp_id="17" deer="5">Яблоневый Сад(60-300, 16ч., 5 оленей)</li>
                        <li exp_id="18" deer="6">Грушевый Сад(120-360, 24ч., 6 оленей)</li>
                    </ul>
                </div>
            </div>
        </fieldset>
        <fieldset id="saved_expeditions">
            <legend>Сохраненные экспедиции</legend>
        </fieldset>
        <fieldset id="active_expeditions">
            <legend>Активные экспедиции</legend>
        </fieldset>
    </fieldset>
</div>
</body>
</html>
