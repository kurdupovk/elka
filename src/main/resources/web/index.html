<html>
<!-- 
{"sessionKey":"eaf3dceb6272d182d16a4df975a47b0d","version":10,"suid":"12143235","aid":"4606044","uid":"6591130","authKey":"e87047d9d5aac0a66cfb477c36120568","params":{"online":["1128402"],"friendIds":["1128402","12482981"]},"sign":"792bb22d8c220a0be88beef385e2f957"}

{"sessionKey":"eaf3dceb6272d182d16a4df975a47b0d","version":10,"suid":"12143235","aid":"4606044","uid":"6591130","authKey":"e87047d9d5aac0a66cfb477c36120568","params":{"screenId":2},"sign":"ffe38c739969ccd82d87a750ed9b1a6a"}

getSign({"sessionKey":"eaf3dceb6272d182d16a4df975a47b0d","version":10,"suid":"12143235","aid":"4606044","uid":"6591130","authKey":"e87047d9d5aac0a66cfb477c36120568","params":{"chestId":1,"userId":6417435,"sign":"69a2280216c4db330acafbbf96911083"},"sign":"c4c433844cf83fcacb5bd15bc420db38"},"http://elka2015.ereality.org/friend/getFriend/");



<script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
-->
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>


<script type="text/javascript">

var template = {"sessionKey":"824b89c95b8b349fd3eb8ccdda0ec3ab","version":10,"suid":"1128402","aid":"4606044","uid":"6417435","authKey":"5f5d2a2cd0fd9284436e07eae2de337a","params":{"chestId":1,"userId":6417435}};

var NEXT_CHEST_TIME = 1000 * 3600 * 6;
var THEE_DAYS_MILLIS = 1000 * 3600 * 24 * 3;

var me = {
    suid: "1128402",
    uid: "6417435",
    friends: [{"userId":1454976,"sUserId":"115811776","level":173,"loginTime":1433142505,"likeStatus":0,"hash":"1cead19985b6328f","photo":"http://cs624820.vk.me/v624820776/2c069/pbRRN0-pG3Q.jpg","name":"Каролина Савельева"},{"userId":6591130,"sUserId":"12143235","level":85,"loginTime":1433219274,"likeStatus":0,"hash":"00fa954e96d3fb4a","photo":"http://cs5466.vk.me/u12143235/e_66836e1e.jpg","name":"Константин Курдупов"},{"userId":2883430,"sUserId":"12482981","level":186,"loginTime":1433193329,"likeStatus":0,"hash":"13374f84728d0675","photo":"http://cs10490.vk.me/u12482981/e_c13a6021.jpg","name":"Денис Малышкин"},{"userId":6676640,"sUserId":"139179027","level":1,"loginTime":1427975456,"likeStatus":0,"hash":"86051ebc7f2def54","photo":"http://cs625730.vk.me/v625730027/3706a/wCNc32El9xc.jpg","name":"Елена Александровна"},{"userId":69139,"sUserId":"166552269","level":210,"loginTime":1432984444,"likeStatus":0,"hash":"72156e2bd85ce212","photo":"http://cs623227.vk.me/v623227269/2bd2b/QZM1BkVYDoM.jpg","name":"Аня Дербенёва"},{"userId":6003663,"sUserId":"249336702","level":152,"loginTime":1433225609,"likeStatus":0,"hash":"0571b79d361b2916","photo":"http://cs621724.vk.me/v621724702/e3b2/YlK13bIfnO4.jpg","name":"Татьяна Ефременко"},{"userId":284549,"sUserId":"3713861","level":48,"loginTime":1424583992,"likeStatus":0,"hash":"e2ad1d38634b7f80","photo":"http://cs10553.vk.me/u3713861/e_f8871a63.jpg","name":"Павел Лысенко"},{"userId":459639,"sUserId":"41034465","level":270,"loginTime":1433146505,"likeStatus":0,"hash":"b3d7ef796d5b9669","photo":"http://cs613417.vk.me/v613417465/10f62/lV32TfIFaNo.jpg","name":"Ксюшенька Ратушина"},{"userId":1070767,"sUserId":"66721249","level":56,"loginTime":1433209091,"likeStatus":0,"hash":"f43df328ac1521e7","photo":"http://cs620828.vk.me/v620828249/1a9df/DdU3945F3Rc.jpg","name":"Ирина Ринкевич"},{"userId":3017348,"sUserId":"70089428","level":151,"loginTime":1433214407,"likeStatus":0,"hash":"49b9a8d168c5f1f4","photo":"http://cs629520.vk.me/v629520428/4478/ygspJnjwrsk.jpg","name":"Елена Эрлих"},{"userId":222502,"sUserId":"7307137","level":105,"loginTime":1433136508,"likeStatus":0,"hash":"324472df2922313a","photo":"http://cs622416.vk.me/v622416137/33783/BQJlXYTfaWg.jpg","name":"Екатерина Садовская"},{"userId":1480668,"sUserId":"81945095","level":4,"loginTime":1431582854,"likeStatus":0,"hash":"aa011eae6ad83d65","photo":"http://cs605621.vk.me/v605621095/b309/3sTKB3vbqYk.jpg","name":"Алена Шилкова"}]
};

/*var getSign = function(_arg1, url){
    var _local3 = _arg1.params;
    var params = ["suid", "uid", "aid", "authKey", "sessionKey"];
    for(var i =0; i < params.length; i++) {
        _local3[params[i]] = _arg1[params[i]];
    };
    var split = url.split('/');
    _local3["action"] = split[split.length - 2].toLowerCase();
    _local3["controller"] = split[split.length - 3].toLowerCase();
    _arg1.sign = this.calcParamsArraySign(_local3);
    delete _local3.action;
    delete _local3.controller;
    for(var i =0; i < params.length; i++) {
        delete _local3[params[i]];
    };
    return _arg1;
}

var calcParamsArraySign = function(_arg1){
            var _local4;
            var _local5;
            var _local2 = "";
            var _local3; 
            if(Array.isArray(_arg1)){
            	_local3 = sortArray(_arg1);
            } else {
            	_local3 = sortObject(_arg1);
            }
            _local4 = 0;
            while (_local4 < _local3.length) {
                _local5 = _local3[_local4];
                if(Array.isArray(_local5.value) || _local5.value instanceof Object){
                    _local5.value = calcParamsArraySign(_local5.value);
                }
                _local4++;
            };
            _local4 = 0;
            while (_local4 < _local3.length) {
                _local5 = _local3[_local4];
                _local2 = _local2 + ((_local5.key + "=") + _local5.value);
                if (_local4 < (_local3.length - 1)){
                    _local2 = (_local2 + "&");
                };
                _local4++;
            };
            return CryptoJS.MD5(_local2).toString(CryptoJS.enc.Hex);
        }

var sortArray = function(_arg1){
            var _local2 = [];
            var _local3 = 0;
            while (_local3 < _arg1.length) {
                _local2.push({
                    key:_local3,
                    value:_arg1[_local3]
                });
                _local3++;
            };
            return _local2;
        }

var sortObject = function(_arg1){
            var _local4 = "";
            var _local2 = [];
            var _local3 = false;
            for (_local4 in _arg1) {
                _local2.push({
                    key:_local4,
                    value:_arg1[_local4]
                });
            };
            _local2.sort(function(a,b){return a.key > b.key});
            return _local2;
        }
*/

var signal = function(){
    var audio = document.getElementById('audio');
    if(audio.paused){
        audio.currentTime = 0;
        audio.play();
    }
}

var createTable = function(data){
    var oldTable = document.getElementById("users");
    var newTable = document.createElement('table');
    newTable.id = "users";
    newTable.border = "1px solid #000000";


    data.sort(function(a,b){if(a.time ==0){ return 1} else if(b.time==0) {return -1} else {return parseInt(a.time) - parseInt(b.time)}})
    for (var i = 0; i < data.length; i++){
        var tr = document.createElement('tr');
        var td1 = document.createElement('td');
        var td2 = document.createElement('td');
        var td3 = document.createElement('td');
        var name = document.createTextNode(data[i].name);
        var time = data[i].time;
        var now = new Date().getTime();
        if(time == 0){
            if(now - (data[i].logintime * 1000) > THEE_DAYS_MILLIS){
                time = "not playing";
            } else {
                time = "closed";
                td3.style.backgroundColor = "greenyellow";
            }
        } else {
            time = new Date(data[i].time * 1000 + NEXT_CHEST_TIME);
            if((time - now < 30000) && (time - now > 0)){
                signal();
                td3.style.backgroundColor = "greenyellow";
            }
        }
        var time  = document.createTextNode(time);
        var photo = document.createElement("img");
        photo.src = data[i].photo;
        photo.width = 38;
        photo.height = 38;

        td1.appendChild(photo);
        td2.appendChild(name);
        td3.appendChild(time);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        newTable.appendChild(tr);
    }
    if(oldTable != null){
        document.body.replaceChild(newTable, oldTable);
    } else{
        document.body.appendChild(newTable);
    }
}
var login = function(){
    var jsonCredentials = document.getElementById("cred").value;
    $.post('http://localhost:8080/elka/credentials', "forsefetch=true&cred="+jsonCredentials, function(d){
        if(d.status == "saved"){
            removeLoginDiv();
        }
    }).fail(function(a){
        alert(a.responseJSON.error);
    });
}
var removeLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        document.body.removeChild(loginDiv);
    }
}
var createLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        return;
    }
    var div = document.createElement('div');
    div.id = "login";
    div.style.width = 450;
    div.style.height = 250;
    var textarea = document.createElement('textarea');
    textarea.id = "cred";
    textarea.name = "credentials";
    textarea.cols = 50;
    textarea.rows = 15;
    var button = document.createElement('button');
    button.onclick = login;
    button.innerHTML = "Login";

    div.appendChild(textarea);
    div.appendChild(button);
    document.body.appendChild(div);
}
var failedRequests = 0;
var start = function(){
    $.post('http://localhost:8080/elka/userchests', "", function(d){
        if(d.credentials.valid){
            removeLoginDiv();
            createTable(d.chests);
        } else {
            var table = document.getElementById("users");
            if(table != null){
                document.body.removeChild(table);
            }
            createLoginDiv();
        }
    }).fail(function(a,b,c){
      failedRequests++;
      if(failedRequests >= 10){
        clearInterval(interval);
        var item = document.getElementById("users");
        if(item == null){
            item = document.getElementById('login');
        }
        item = $('#'+item.id);
        $("#overlay").css({
            position: "absolute",
            width: item.width(),
            height: item.height(),
            left: item.position().left,
            top: item.position().top,
            zIndex: 100,
            "background-color": "#000000",
            opacity: 0.7
        });
      }
    });
}
var interval = setInterval(start, 1000);
start();
</script>
<body>
<audio id="audio">
  <source src="beep.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
<div id="overlay"></div>
</body>
</html>
