<html>
<script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
<script type="text/javascript">

var NEXT_CHEST_TIME = 1000 * 3600 * 6;
var THEE_DAYS_MILLIS = 1000 * 3600 * 24 * 3;

var signal = function(){
    var audio = document.getElementById('audio');
    if(audio.paused){
        audio.currentTime = 0;
        audio.play();
    }
}

var createTable = function(data){
    var oldTable = document.getElementById("users");
    var newTable = document.createElement('table');
    newTable.id = "users";
    newTable.border = "1px solid #000000";

    var colNames = ["Photo", "Friend", "Next chest time", "Opened by"];
    var names = document.createElement('tr');
    for(var i in colNames) {
        var td = document.createElement('td');
        td.style.textAlign = "center";
        td.appendChild(document.createTextNode(colNames[i]));
        names.appendChild(td);
    }
    newTable.appendChild(names);

    data.sort(function(a,b){if(a.time ==0){ return 1} else if(b.time==0) {return -1} else {return parseInt(a.time) - parseInt(b.time)}})
    for (var i = 0; i < data.length; i++){
        var tr = document.createElement('tr');
        var td1 = document.createElement('td');
        var td2 = document.createElement('td');
        var td3 = document.createElement('td');
        var td4 = document.createElement('td');
        var name = document.createTextNode(data[i].name);
        var time = data[i].time;
        var now = new Date().getTime();
        if(now - (data[i].logintime * 1000) > THEE_DAYS_MILLIS) {
                time = "not playing";
        } else if(time == 0) {
                time = "closed";
                td3.style.backgroundColor = "greenyellow";
        } else {
            time = new Date(data[i].time * 1000 + NEXT_CHEST_TIME);
            if((time - now < 30000) && (time - now > 0)){
                signal();
                td3.style.backgroundColor = "greenyellow";
            }
            if(data[i].openedBy) {
                var openedBy = data[i].openedBy;
                var openedPhoto = document.createElement("img");
                openedPhoto.src = openedBy.photo;
                openedPhoto.width = 38;
                openedPhoto.height = 38;
                openedPhoto.style.verticalAlign = "middle";
                td4.appendChild(openedPhoto);
                td4.appendChild(document.createTextNode(openedBy.name));
            }
        }
        var time  = document.createTextNode(time);
        var photo = document.createElement("img");
        photo.src = data[i].photo;
        photo.width = 38;
        photo.height = 38;

        td1.appendChild(photo);
        td2.appendChild(name);
        td3.appendChild(time);
        tr.appendChild(td1);
        tr.appendChild(td2);
        tr.appendChild(td3);
        tr.appendChild(td4);
        newTable.appendChild(tr);
    }
    if(oldTable != null){
        document.body.replaceChild(newTable, oldTable);
    } else{
        document.body.appendChild(newTable);
    }
}
var login = function(){
    var jsonCredentials = document.getElementById("cred").value;
    $.post('http://localhost:8080/elka/credentials', "forsefetch=true&cred="+jsonCredentials, function(d){
        if(d.status == "saved"){
            removeLoginDiv();
        }
    }).fail(function(a){
        alert(a.responseJSON.error);
    });
}
var removeLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        document.body.removeChild(loginDiv);
    }
}
var createLoginDiv = function(){
    var loginDiv = document.getElementById("login");
    if(loginDiv != null){
        return;
    }
    var div = document.createElement('div');
    div.id = "login";
    div.style.width = 450;
    div.style.height = 250;
    var textarea = document.createElement('textarea');
    textarea.id = "cred";
    textarea.name = "credentials";
    textarea.cols = 50;
    textarea.rows = 15;
    var button = document.createElement('button');
    button.onclick = login;
    button.innerHTML = "Login";

    div.appendChild(textarea);
    div.appendChild(button);
    document.body.appendChild(div);
}
var failedRequests = 0;
var start = function(){
    $.post('http://localhost:8080/elka/userchests', "", function(d){
        if(d.credentials.valid){
            removeLoginDiv();
            createTable(d.chests);
        } else {
            var table = document.getElementById("users");
            if(table != null){
                document.body.removeChild(table);
            }
            createLoginDiv();
        }
    }).fail(function(a,b,c){
      failedRequests++;
      if(failedRequests >= 10){
        clearInterval(interval);
        var item = document.getElementById("users");
        if(item == null){
            item = document.getElementById('login');
        }
        item = $('#'+item.id);
        $("#overlay").css({
            position: "absolute",
            width: item.width(),
            height: item.height(),
            left: item.position().left,
            top: item.position().top,
            zIndex: 100,
            "background-color": "#000000",
            opacity: 0.7
        });
      }
    });
}
var interval = setInterval(start, 1000);
start();
</script>
<body>
<audio id="audio">
  <source src="beep.mp3" type="audio/mpeg">
Your browser does not support the audio element.
</audio>
<div id="overlay"></div>
</body>
</html>
